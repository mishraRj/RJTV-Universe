<% layout("/layouts/showBoilerplate") %>
<% pageClass = isHorror ? 'horror-bg' : 'default-bg' %>

<div class="main-content <%= isHorror ? 'horror-bg' : '' %>">
    <div class="col-7 movie-info">
        <img src="<%= movie.banner %>" class="banner-img" alt="Movie Banner">
            <div class="movie-overlay">
                <div class="poster">
                    <img src="<%= movie.image.url %>" alt="Movie Poster" class="movie-poster">
                </div>
                
                <div class="movie-details">
                    <h1 class="movie-title"><%= movie.title %></h1>
                    <ul class="inline-list">
                    <li class="unselectable" id="movie-year"><%= movie.year %></li>
                    <li class="unselectable" id="movie-language"><%= movie.language.join(', ') %></li>
                    <li class="unselectable"><span class="badge text-bg-danger" id="trailer-rating">U/A 13+</span></li>
                </ul>
                    <p class="unselectable" id="movie-genre"><%= movie.genre.join(' | ') %></p>
                    <p class="unselectable" class="movie-description">
                        <%= movie.description %>
                    </p>
                    <!-- Buttons Section -->
                    <% if(movie.movieClass !== "comingSoon") {%>
                        <div class="buttons">
                            <a href="/home_page/<%= movie.id %>-<%= movie.title %>/player"><button  class="watch-btn">‚ñ∂ Watch Now</button></a>
                            <%
                                const inWatchLater = currUser && currUser.watchLater.some(item =>
                                    item.movieId.toString() === movie._id.toString() &&
                                    item.sourceCollection === movie.channel
                                );
                            %>

                            <form action="/watchLater/toggle" method="POST" style="display: inline;">
                                <input type="hidden" name="movieId" value="<%= movie._id %>">
                                <input type="hidden" name="sourceCollection" value="<%= movie.channel %>">
                                <input type="hidden" name="movieTitle" value="<%= movie.title %>">
                                <button type="submit" class="watch-btn">
                                    <%= currUser && currUser.watchLater.some(item => item.movieId.equals(movie._id) && item.sourceCollection === (movie.channel)) ? '‚úì' : '+' %>
                                </button>
                            </form>
                        </div>
                        <div class="buttons">
                            <a href="#play-trailer" class="trailer-btn">‚ñ∂ Watch Trailer</a>
                            <% if(currUser) { %>
                                <div class="fav-wrapper" data-id="<%= movie._id %>" data-collection="<%= movie.channel %>" data-title="<%= movie.title %>">
                                    <i class="fa-heart heart-icon <%= currUser && currUser.favorites.some(fav => fav.movieId.equals(movie._id) && fav.sourceCollection === movie.channel) ? 'fa-solid' : 'fa-regular' %>"></i>
                                    <span class="fav-tooltip">
                                        <%= currUser && currUser.favorites.some(fav => fav.movieId.equals(movie._id) && fav.sourceCollection === movie.channel) ? 'Added to favs' : 'Add to favs' %>
                                    </span>
                                </div>
                            <% } %>
                        </div>
                    <% } else { %>
                        <div class="buttons">
                            <a href="#play-trailer" class="trailer-btn">‚ñ∂ Watch Trailer</a>
                        </div>
                    <% } %>
                </div>
            </div>
    </div>

    <audio id="HorrorTransitionAudio" loop>
        <source src="https://cdn.jsdelivr.net/gh/mishraRj/rjtv-trailers/ghosts/hrTransition.mp3"
                type="audio/mp3"
        >
        Your browser does not support the audio element.
    </audio>

    <audio id="alienVoice">
        <source src="https://cdn.jsdelivr.net/gh/mishraRj/rjtv-trailers/General%20Data/alien-voice.mp3" 
        type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <div class="col-7 play-trailer mt-5 mb-2" id="play-trailer">
        <div class="trailer-title">
            <h3 id="show-title"><%= movie.title %> Official Trailer</h3>
        </div>
        <div class="iframeT">
            <iframe 
                src="<%= movie.trailer.replace('youtu.be/', 'www.youtube.com/embed/') %>" 
                class="trailer-player"
                allowfullscreen
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
            </iframe>
            <div class="projector-container">
                <img src="https://cdn.jsdelivr.net/gh/mishraRj/rjtv-trailers/spaceships/newAlienProjector.png" class="projector" alt="">
            </div>
        </div>
    </div>
    <br><br><br>

    <% if(movie.reviews.length !== 0) { %>
        <div class="container swiper">
            <h2 id="review-heading">All Reviews</h2>
            <div class="slider-wrapper">
                <div class="card-list swiper-wrapper">
                    <% for(let i = movie.reviews.length - 1; i >= 0; i--) { %>
                    <div class="card-item swiper-slide">
                            <div class="profile">
                                <div class="pic">
                                    <img src="<%= movie.reviews[i].author.avatar %>" alt="userImg" class="user-image">
                                </div>
                                <div class="username">
                                    <div class="name"><h3><%= movie.reviews[i].author.username %> </h3></div>
                                    <div class="ratings">
                                        <p class="starability-result" data-rating="<%= movie.reviews[i].rating %>"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-content">
                                <p><%= movie.reviews[i].comment %></p>
                            </div>
                        <% if(currUser && currUser._id.equals(movie.reviews[i].author._id)) { %>
                            <form action="/home_page/<%= movie._id %>/reviews/<%= movie.reviews[i]._id %>?_method=DELETE" method="POST" class="rvw-delete-form">
                                <div class="card-btn">
                                    <button class="msg-btn">
                                        Delete
                                    </button>
                                </div>
                            </form>
                        <% } %>
                    </div>
                    <% } %>
                </div>

                <!-- If we need pagination -->
                <div class="swiper-pagination"></div>
                <!-- If we need navigation buttons -->
                <div class="swiper-slide-button swiper-button-prev"></div>
                <div class="swiper-slide-button swiper-button-next"></div>
            </div>
                </div>
    <% } %>
    <!-- Review Form -->
        <% if(currUser) {%>
            <div class="col-10 review-section">
                <hr>

                    <h2 id="review-title">Cosmic Review Portal ü™ê</h2>
                    <form action="/home_page/<%= movie._id %>/reviews" method="POST" novalidate class="needs-validation">
                    <div class="mt-3 mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <fieldset class="starability-heart">
                            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                            <label for="first-rate1" title="Terrible">1 star</label>
                            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                            <label for="first-rate2" title="Not good">2 stars</label>
                            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                            <label for="first-rate3" title="Average">3 stars</label>
                            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                            <label for="first-rate4" title="Very good">4 stars</label>
                            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                            <label for="first-rate5" title="Amazing">5 stars</label>
                        </fieldset>
                    </div>

                        <div class="mb-3">
                            <label for="comment" class="form-label">Add Comment</label>
                            <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
                            <div class="invalid-feedback">Some comment required!</div>
                        </div>
                        <button class="btn btn-success rvw-submit-btn">Submit</button>
                    </form>
                    <hr>
            </div>
        <% } %>
            <hr class="content-line">
            <div class="container swiper" id="container">
            <h2 class="content-headings">More Like This...</h2>
                <div  id="slider-wrapper">
                    <div class="card-list swiper-wrapper" id="card-list">
                        <% for(let movies of recommendedMovies) { %>
                            <div class="card-item swiper-slide" id="card-item">
                                <a href="/home_page/<%= movies._id %>-<%= movie.title %>">
                                    <img src="<%= movies.image.url %>" alt="img" class="user-image" id="user-image">
                                </a>
                            </div>
                        <% } %>
                    </div>
                <!-- If we need navigation buttons -->
                <div class="swiper-slide-button swiper-button-prev"></div>
                <div class="swiper-slide-button swiper-button-next"></div>
                </div>
            </div>
</div>

